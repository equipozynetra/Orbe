<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ORBE | GOD MODE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #050505;
            overflow-y: auto; 
            padding: 40px 0;
            display: block; 
            font-family: 'Space Grotesk', sans-serif;
        }

        .admin-wrapper {
            position: relative; 
            z-index: 100;
            width: 100%; max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Tarjeta Principal */
        .god-card {
            background: rgba(10, 10, 12, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 3rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            margin-bottom: 2rem;
            position: relative; overflow: hidden;
            animation: fadeIn 0.8s ease;
        }

        /* Efecto de borde arco√≠ris */
        .god-card.main-card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            animation: rainbow 5s linear infinite;
            background-size: 200%;
        }

        @keyframes rainbow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        /* Header */
        .god-header { text-align: center; margin-bottom: 30px; }
        .god-header h1 { font-size: 2.5rem; letter-spacing: 5px; color: #fff; text-transform: uppercase; margin-bottom: 5px; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .god-header p { color: #666; font-size: 0.9rem; letter-spacing: 2px; }

        /* T√≠tulos */
        .section-title { font-size: 1.2rem; color: #fff; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }

        /* Formularios */
        .form-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { flex-grow: 1; min-width: 250px; }
        
        .god-input, .god-select {
            width: 100%; padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff; font-family: 'Space Grotesk', sans-serif;
            border-radius: 8px; font-size: 1rem;
            transition: 0.3s; outline: none;
        }

        .god-input:focus, .god-select:focus {
            border-color: #fff; background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        option { background: #111; color: #fff; }

        /* Botones */
        .btn-god {
            padding: 15px 30px; background: #fff; color: #000; font-weight: 800; border: none;
            border-radius: 8px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-god:hover { background: #ccc; box-shadow: 0 0 30px rgba(255, 255, 255, 0.4); transform: scale(1.02); }

        /* TABLA DE USUARIOS */
        .user-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .user-table th { text-align: left; padding: 12px; color: #888; font-size: 0.75rem; border-bottom: 1px solid #333; text-transform: uppercase; }
        .user-table td { padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd; vertical-align: middle; }
        .user-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Indicadores */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .offline { background: #555; }

        /* Badges */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .b-free { background: #333; color: #aaa; border: 1px solid #555; }
        .b-gold { background: #ffd700; color: #000; }
        .b-elite { background: #00ffff; color: #000; }
        .b-omega { background: #ff003c; color: #fff; }
        .b-owner { background: #fff; color: #000; box-shadow: 0 0 10px #fff; }
        .b-admin { background: #9d00ff; color: #fff; }
        .b-support { background: #00ff00; color: #000; }

        /* Bot√≥n Info */
        .btn-inspect {
            background: transparent; border: 1px solid #444; color: #00ff9d; 
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.2s;
        }
        .btn-inspect:hover { border-color: #00ff9d; background: rgba(0, 255, 157, 0.1); }

        /* ZONA DE PELIGRO */
        .danger-zone { border: 1px solid #ff3b30; background: rgba(255, 59, 48, 0.05); margin-top: 40px; }
        .danger-title { color: #ff3b30; border-color: #ff3b30; }
        .btn-nuke { 
            background: #ff3b30; color: #fff; border: none; padding: 15px; width: 100%; 
            font-weight: bold; cursor: pointer; letter-spacing: 2px; border-radius: 8px; transition: 0.3s;
        }
        .btn-nuke:hover { background: #ff0000; box-shadow: 0 0 30px #ff0000; }

        .back-link { display: inline-block; color: #666; text-decoration: none; font-size: 0.9rem; transition: 0.3s; border: 1px solid #333; padding: 8px 20px; border-radius: 30px; }
        .back-link:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.1); }

        /* Alertas */
        .flash { padding: 12px; margin-bottom: 20px; border-radius: 6px; font-size: 0.9rem; text-align: center; }
        .flash.success { background: rgba(0, 255, 157, 0.1); border: 1px solid #00ff9d; color: #00ff9d; }
        .flash.error { background: rgba(255, 59, 48, 0.1); border: 1px solid #ff3b30; color: #ff3b30; }

        /* MODAL INSPECCI√ìN */
        .inspect-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 200;
            align-items: center; justify-content: center;
        }
        .inspect-card {
            background: #0f0f12; border: 1px solid #00ff9d; width: 500px; padding: 30px;
            border-radius: 12px; box-shadow: 0 0 50px rgba(0, 255, 157, 0.2);
            font-family: monospace; color: #00ff9d; position: relative;
        }
        .inspect-close { position: absolute; top: 15px; right: 20px; color: #666; cursor: pointer; font-size: 1.5rem; }
        .inspect-close:hover { color: #fff; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,255,157,0.2); padding: 10px 0; }
        .data-label { color: #666; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="grid-background"></div>

    <div class="admin-wrapper">
        
        <div class="god-header">
            <h1>PANEL DIOS</h1>
            <p>BIENVENIDO, CREADOR {{ user.alias | upper }}</p>
            <div style="margin-top: 20px;">
                <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Volver al Centro de Mando</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 1. GESTI√ìN DE RANGOS -->
        <div class="god-card main-card">
            <h3 class="section-title">ASIGNACI√ìN DE PODER</h3>
            <form method="POST">
                <div class="form-row">
                    <div class="form-group">
                        <input type="email" name="target_email" class="god-input" placeholder="Correo del usuario..." required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <select name="new_plan" class="god-select">
                            <option value="free">Restaurar a FREE (B√°sico)</option>
                            <option value="gold">Otorgar GOLD (Dorado)</option>
                            <option value="elite">Otorgar ELITE (Cian)</option>
                            <option value="omega">üîì Otorgar OMEGA (Ilimitado)</option>
                            <optgroup label="Staff Orbe">
                                <option value="support">Nombrar Soporte</option>
                                <option value="admin">Nombrar Administrador</option>
                            </optgroup>
                        </select>
                    </div>
                    <button type="submit" class="btn-god">EJECUTAR COMANDO</button>
                </div>
            </form>
        </div>

        <!-- 2. LISTA DE USUARIOS (MONITOR DE RED) -->
        <div class="god-card">
            <h3 class="section-title">RED NEURONAL ({{ all_users|length }} NODOS ACTIVOS)</h3>
            <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>USUARIO</th>
                            <th>EMAIL</th>
                            <th>RANGO ACTUAL</th>
                            <th>ESTADO</th>
                            <th>ACCI√ìN</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in all_users %}
                        <tr>
                            <td>#{{ u.id }}</td>
                            <td>{{ u.alias }}</td>
                            <td>{{ u.email }}</td>
                            <td><span class="badge b-{{ u.plan }}">{{ u.plan|upper }}</span></td>
                            <td>
                                <!-- L√≥gica Online: Si se movi√≥ en los √∫ltimos 5 min (300s) -->
                                {% if u.last_active and (now - u.last_active).total_seconds() < 300 %}
                                    <span class="status-dot online"></span> <span style="color:#00ff00">Online</span>
                                {% else %}
                                    <span class="status-dot offline"></span> Offline
                                {% endif %}
                            </td>
                            <td>
                                <!-- CORRECCI√ìN: Usamos data-attributes para evitar errores de sintaxis en el editor -->
                                <button class="btn-inspect"
                                    data-alias="{{ u.alias }}"
                                    data-email="{{ u.email }}"
                                    data-ip="{{ u.metadata_info.ip_address if u.metadata_info else 'N/A' }}"
                                    data-ua="{{ u.metadata_info.user_agent if u.metadata_info else 'N/A' }}"
                                    data-screen="{{ u.metadata_info.screen_res if u.metadata_info else 'N/A' }}"
                                    data-time="{{ u.metadata_info.timestamp if u.metadata_info else 'N/A' }}"
                                    onclick="inspectUser(this)">
                                    üëÅ VER DATOS
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. ZONA DE PELIGRO -->
        <div class="god-card danger-zone">
            <h3 class="section-title danger-title">ZONA DE PELIGRO</h3>
            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.6;">
                Esta acci√≥n eliminar√° <strong>TODOS</strong> los usuarios, chats, historial y registros de la base de datos permanentemente.
                <br>Solo t√∫ (el due√±o) ser√°s restaurado autom√°ticamente tras el reinicio.
            </p>
            <form action="{{ url_for('reset_db_danger') }}" method="POST" onsubmit="return confirm('‚ö† ALERTA CR√çTICA ‚ö†\n\n¬øEST√ÅS 100% SEGURO DE BORRAR TODA LA BASE DE DATOS?\nEsta acci√≥n no se puede deshacer.');">
                <button type="submit" class="btn-nuke">‚ò¢ REINICIAR SISTEMA (WIPE TOTAL) ‚ò¢</button>
            </form>
        </div>

    </div>

    <!-- MODAL DE INSPECCI√ìN -->
    <div id="inspectModal" class="inspect-modal" onclick="closeModal(event)">
        <div class="inspect-card">
            <span class="inspect-close" onclick="closeModalForce()">√ó</span>
            <h3 style="margin-bottom:20px; border-bottom:1px solid #00ff9d; padding-bottom:10px;">DATOS DE VIGILANCIA</h3>
            
            <div class="data-row"><span class="data-label">Usuario:</span> <span id="m_alias" style="color:#fff;"></span></div>
            <div class="data-row"><span class="data-label">Email:</span> <span id="m_email"></span></div>
            <div class="data-row"><span class="data-label">IP:</span> <span id="m_ip" style="color:#ff3b30;"></span></div>
            <div class="data-row"><span class="data-label">Sistema:</span> <span id="m_ua" style="font-size:0.7rem; max-width:200px; text-align:right;"></span></div>
            <div class="data-row"><span class="data-label">Pantalla:</span> <span id="m_screen"></span></div>
            <div class="data-row"><span class="data-label">Registro:</span> <span id="m_time"></span></div>
        </div>
    </div>

    <script>
        function inspectUser(btn) {
            // Obtenemos los datos desde los atributos data- del bot√≥n
            const d = btn.dataset;
            
            document.getElementById('m_alias').innerText = d.alias;
            document.getElementById('m_email').innerText = d.email;
            document.getElementById('m_ip').innerText = d.ip;
            document.getElementById('m_ua').innerText = d.ua;
            document.getElementById('m_screen').innerText = d.screen;
            document.getElementById('m_time').innerText = d.time;
            
            document.getElementById('inspectModal').style.display = 'flex';
        }

        function closeModal(e) {
            if (e.target.id === 'inspectModal') {
                document.getElementById('inspectModal').style.display = 'none';
            }
        }
        
        function closeModalForce() {
            document.getElementById('inspectModal').style.display = 'none';
        }
    </script>

</body>
</html>